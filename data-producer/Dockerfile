FROM ubuntu:latest

RUN apt-get update && \
  apt-get install -y openjdk-11-jdk wget vim sudo gcc g++ make librdkafka-dev pkg-config libglib2.0-dev

#install kafka
WORKDIR /usr/local
RUN wget https://downloads.apache.org/kafka/3.3.2/kafka_2.12-3.3.2.tgz && \
  tar -zxvf kafka_2.12-3.3.2.tgz && \
  mv kafka_2.12-3.3.2 kafka && \
  rm kafka_2.12-3.3.2.tgz

#copy files generated by data generator in mitsimlab container
COPY --chown=root:root /MITSIMLab/mitsim/data/cardatapoints.out /MITSIMLab/mitsim/data/historical-tolls.out /MITSIMLab/mitsim/data/maxCarid.out /usr/local/lrb/dgoutput/

#copy files for producing generated data via kafka
WORKDIR /usr/local/lrb/datadriver
COPY --chown=root:root datadriver/* /usr/local/lrb/datadriver/

#compile and link datadriver files
RUN g++ -c `pkg-config --cflags glib-2.0 rdkafka` DataFeeder.cpp && \
  g++ -c LRDataProvider.cpp && \
  g++ -c MemTuples.cpp && \
  g++ -c Tuple.cpp && \
  g++ -o datafeeder DataFeeder.o `pkg-config --libs glib-2.0 rdkafka` -lpthread LRDataProvider.o MemTuples.o Tuple.o